# This is a basic workflow to help you get started with Actions

name: phpunit

on: push

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    
    #container:
     # image: juampynr/drupal8ci:latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2
    
    - name: install dependencies
      run: |
          apt-get update -y
          apt-get install libyaml-dev -y
          pecl install yaml && echo "extension=yaml.so" > /usr/local/etc/php/conf.d/ext-yaml.ini && docker-php-ext-enable yaml
    - name: composer update
      run: |
        composer update
        
    - name: install drupal
      run: |
        git clone http://git.drupal.org/project/drupal.git 
        cd drupal && composer install && cd -
        mkdir -p drupal/modules/arche-gui
        - for d in $(pwd)/*; do ln -s "$d" "drupal/modules/arche-gui"; done
        
    - name: check directories
      run: |
        ls -la  
        cd drupal/modules && ls -la
        cd arche-gui && ls -la
       
        
    - name: test
      run: |
        mkdir -p build/logs
        ./vendor/phpunit/phpunit/phpunit
        
    - name: coveralls
      run: |
        export COVERALLS_RUN_LOCALLY=1
        export COVERALLS_REPO_TOKEN=${{ secrets.coverallsLocalToken }}
        composer require php-coveralls/php-coveralls
        php vendor/bin/php-coveralls -v    
